{% extends "base.html" %}
{% block title %}Tabular ML{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('tabular_ml.static', filename='css/index.css') }}">
{% endblock %}
{% block content %}
  {% set upload_settings = plugin_settings.get('upload', {}) %}
  {% set docs_url = plugin_settings.get('docs') %}
  {% if docs_url %}
    {% set help_href = docs_url + ('&' if '?' in docs_url else '?') + 'theme=' + current_theme %}
  {% else %}
    {% set help_href = url_for('help_page', slug='tabular_ml', theme=current_theme) %}
  {% endif %}
  <section class="shell surface-block tabular-shell" aria-labelledby="tabular-ml-title">
    <div class="tool-shell__layout">
      <aside class="tool-shell__intro">
        <div class="tool-shell__icon" aria-hidden="true">
          <img src="{{ url_for('tabular_ml.static', filename='img/tabular_icon.svg') }}" alt="">
        </div>
        <p class="tool-card__category">Machine Learning</p>
        <h1 id="tabular-ml-title" class="section-heading">Tabular ML sandbox</h1>
        <p>
          Load CSV datasets entirely in memory, preview records, generate scatter plots, and train lightweight models. All computations are performed offline in this browser session.
        </p>
        <ul>
          <li>Automatic task detection (classification or regression)</li>
          <li>Column statistics and top feature importances</li>
          <li>SVG scatter plots with optional colour encoding</li>
        </ul>
        <div class="tool-shell__actions">
          <a class="btn btn--subtle" data-keep-theme href="{{ help_href }}">Read ML guide</a>
        </div>
      </aside>

      <div class="tool-shell__workspace">
        <form id="dataset-form" class="surface-muted form-grid" enctype="multipart/form-data" novalidate>
          <div class="dropzone" id="dataset-dropzone">
            <div class="dropzone__copy">
              <h2 class="section-heading">Load CSV dataset</h2>
              <p class="dropzone__hint">Data remains in this session. Max size {{ upload_settings.get('max_mb', 2) }} MB. Ensure the first row contains column headers.</p>
              <p class="dropzone__hint" id="dataset-name" aria-live="polite"></p>
            </div>
            <div class="dropzone__actions">
              <button class="btn" type="button" id="dataset-browse">Browse CSV</button>
            </div>
            <input id="dataset" name="dataset" type="file" accept="text/csv,application/vnd.ms-excel" class="visually-hidden" required>
          </div>
          <div class="form-actions">
            <button class="btn" type="submit">Load dataset</button>
            <button class="btn btn--ghost" type="reset" id="dataset-reset">Reset</button>
          </div>
          <p class="status-text" data-role="status" aria-live="polite"></p>
        </form>

        <section id="dataset-overview" class="surface-muted tabular-overview" hidden aria-live="polite">
          <header class="tabular-overview__header">
            <div>
              <p class="tool-card__category">Dataset preview</p>
              <h2 class="form-section__title" id="dataset-title">Loaded dataset</h2>
              <p class="form-field__hint" id="dataset-shape"></p>
            </div>
            <button class="btn btn--ghost" type="button" id="dataset-clear">Remove dataset</button>
          </header>
          <div class="tabular-overview__grid">
            <div>
              <h3 class="form-section__title">Sample rows</h3>
              <div class="preview-table" role="region" aria-live="polite">
                <table id="preview-table"></table>
              </div>
            </div>
            <div>
              <h3 class="form-section__title">Column summary</h3>
              <ul id="column-summary" class="tabular-columns list-reset"></ul>
            </div>
          </div>
          <div class="tabular-overview__grid tabular-overview__grid--visuals">
            <section class="tabular-card">
              <header class="tabular-card__header">
                <h3 class="form-section__title" id="scatter-section-title">Scatter plot</h3>
                <button type="button" class="settings-button" id="scatter-settings" data-settings-target="scatter" aria-haspopup="dialog" aria-controls="settings-dialog" aria-label="Scatter plot settings">
                  <span aria-hidden="true">⚙️</span>
                </button>
              </header>
              <form id="scatter-form" class="form-grid" novalidate aria-labelledby="scatter-section-title">
                <div class="input-grid">
                  <div class="form-field">
                    <label class="form-field__label" for="scatter-x">X axis</label>
                    <select id="scatter-x" name="x"></select>
                  </div>
                  <div class="form-field">
                    <label class="form-field__label" for="scatter-y">Y axis</label>
                    <select id="scatter-y" name="y"></select>
                  </div>
                  <div class="form-field">
                    <label class="form-field__label" for="scatter-color">Colour (optional)</label>
                    <select id="scatter-color" name="color"></select>
                    <p class="form-field__hint">Use categorical columns to highlight clusters.</p>
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn" type="submit">Render scatter</button>
                  <button class="btn btn--ghost" type="reset" id="scatter-reset">Reset</button>
                </div>
                <p class="status-text" data-role="status" aria-live="polite"></p>
              </form>
              <figure class="scatter-figure">
                <svg id="scatter-plot" viewBox="0 0 480 320" role="img" aria-labelledby="scatter-title" hidden>
                  <title id="scatter-title">Scatter plot</title>
                </svg>
                <figcaption id="scatter-caption" class="form-field__hint"></figcaption>
              </figure>
            </section>
            <section class="tabular-card">
              <header class="tabular-card__header">
                <h3 class="form-section__title" id="histogram-section-title">Histogram</h3>
                <button type="button" class="settings-button" id="histogram-settings" data-settings-target="histogram" aria-haspopup="dialog" aria-controls="settings-dialog" aria-label="Histogram settings">
                  <span aria-hidden="true">⚙️</span>
                </button>
              </header>
              <form id="histogram-form" class="form-grid" novalidate aria-labelledby="histogram-section-title">
                <div class="form-field">
                  <label class="form-field__label" for="histogram-column">Column</label>
                  <select id="histogram-column" name="column"></select>
                  <p class="form-field__hint">Select a numeric column to visualise its distribution.</p>
                </div>
                <div class="form-actions">
                  <button class="btn" type="submit">Generate histogram</button>
                  <button class="btn btn--ghost" type="reset" id="histogram-reset">Reset</button>
                </div>
                <p class="status-text" data-role="status" aria-live="polite"></p>
              </form>
              <figure class="histogram-figure">
                <svg id="histogram-plot" viewBox="0 0 480 320" role="img" aria-labelledby="histogram-title" hidden>
                  <title id="histogram-title">Histogram</title>
                </svg>
                <figcaption id="histogram-caption" class="form-field__hint"></figcaption>
              </figure>
            </section>
            <section class="tabular-card">
              <header class="tabular-card__header">
                <h3 class="form-section__title" id="training-section-title">Train model</h3>
                <button type="button" class="settings-button" id="training-settings" data-settings-target="training" aria-haspopup="dialog" aria-controls="settings-dialog" aria-label="Training settings">
                  <span aria-hidden="true">⚙️</span>
                </button>
              </header>
              <form id="train-form" class="form-grid" novalidate aria-labelledby="training-section-title">
                <div class="form-field">
                  <label class="form-field__label" for="target">
                    Target column
                    <button type="button" class="tooltip-trigger" data-tooltip="Provide the column name to predict. Only numeric features are used for training." aria-label="Target column help">?</button>
                  </label>
                  <input id="target" name="target" placeholder="e.g. hardness" required>
                  <p class="form-field__hint">Matches the header name in the CSV file.</p>
                </div>
                <div class="form-field">
                  <label class="form-field__label" for="algorithm">
                    Algorithm
                    <span class="form-field__hint">Choose an estimator style. Automatic picks a strong baseline for the detected task.</span>
                  </label>
                  <select id="algorithm" name="algorithm">
                    <option value="auto">Automatic (recommended)</option>
                    <option value="linear_model">Generalised linear model</option>
                    <option value="random_forest">Random forest ensemble</option>
                    <option value="gradient_boosting">Gradient boosting ensemble</option>
                  </select>
                </div>
                <div class="form-actions">
                  <button class="btn" type="submit">Train model</button>
                  <button class="btn btn--ghost" type="reset" id="train-reset">Reset</button>
                </div>
                <p class="status-text" data-role="status" aria-live="polite"></p>
              </form>
              <section id="train-results" class="surface-muted tabular-results" hidden>
                <header class="tabular-results__header">
                  <div>
                    <p class="tool-card__category">Training results</p>
                    <h4 class="form-section__title">Performance summary</h4>
                  </div>
                  <div class="tabular-results__badges">
                    <p id="task" class="badge"></p>
                    <p id="algorithm-used" class="badge badge--muted"></p>
                  </div>
                </header>
                <div class="tabular-results__grid">
                  <div>
                    <h5 class="form-section__title">Metrics</h5>
                    <dl id="metrics" class="tabular-metrics"></dl>
                  </div>
                  <div>
                    <h5 class="form-section__title">Top features</h5>
                    <ul id="importance" class="tabular-importance list-reset"></ul>
                  </div>
                  <div>
                    <h5 class="form-section__title">Prediction preview</h5>
                    <div class="prediction-preview" role="region" aria-live="polite">
                      <table id="prediction-table" class="tabular-predictions"></table>
                    </div>
                    <div class="tabular-results__actions">
                      <button class="btn btn--subtle" type="button" id="download-predictions">Download CSV</button>
                      <button class="btn btn--ghost" type="button" id="download-json">Download JSON</button>
                    </div>
                  </div>
                  <div>
                    <h5 class="form-section__title">Run inference</h5>
                    <p class="form-field__hint">Use the trained model to predict new rows.</p>
                    <section id="inference-section" class="tabular-inference" hidden>
                      <form id="inference-form" class="form-grid" novalidate>
                        <div id="inference-fields" class="input-grid"></div>
                        <p id="inference-empty" class="form-field__hint" hidden>
                          This model requires numeric feature columns. No compatible features were detected.
                        </p>
                        <div class="form-actions">
                          <button class="btn" type="submit">Predict</button>
                          <button class="btn btn--ghost" type="reset" id="inference-reset">Reset</button>
                        </div>
                        <p class="status-text" data-role="status" aria-live="polite"></p>
                      </form>
                      <div id="inference-output" class="tabular-inference__output" hidden aria-live="polite" role="status">
                        <p id="inference-value" class="tabular-inference__value"></p>
                        <dl id="inference-probabilities" class="tabular-inference__probabilities"></dl>
                      </div>
                      <section class="tabular-inference__batch">
                        <h6 class="tabular-inference__heading">Batch predictions</h6>
                        <p class="form-field__hint">Upload a CSV with the same feature columns. Omit the target column.</p>
                        <form id="batch-form" class="form-grid" enctype="multipart/form-data" novalidate>
                          <div class="form-field">
                            <label class="form-field__label" for="batch-file">Batch CSV</label>
                            <input id="batch-file" name="dataset" type="file" accept="text/csv,application/vnd.ms-excel" required>
                          </div>
                          <div class="form-actions">
                            <button class="btn" type="submit">Run batch predictions</button>
                            <button class="btn btn--ghost" type="reset" id="batch-reset">Reset</button>
                          </div>
                          <p class="status-text" data-role="status" aria-live="polite"></p>
                        </form>
                        <section id="batch-results" class="tabular-inference__batch-results" hidden aria-live="polite">
                          <header class="tabular-inference__batch-header">
                            <p id="batch-summary" class="form-field__hint"></p>
                            <div class="tabular-results__actions">
                              <button class="btn btn--subtle" type="button" id="batch-download">Download CSV</button>
                            </div>
                          </header>
                          <div class="prediction-preview" role="region">
                            <table id="batch-table" class="tabular-predictions"></table>
                          </div>
                        </section>
                      </section>
                    </section>
                  </div>
                </div>
              </section>
            </div>
          </div>
          <section class="surface-muted tabular-preprocess" id="preprocess-section" hidden>
            <header class="tabular-preprocess__header">
              <div>
                <p class="tool-card__category">Data preprocessing</p>
                <h3 class="form-section__title">Refine dataset</h3>
                <p class="form-field__hint">Detect outliers or apply quick filters before training.</p>
              </div>
            </header>
            <div class="tabular-preprocess__grid">
              <section class="tabular-card">
                <header class="tabular-card__header">
                  <h4 class="form-section__title" id="outlier-section-title">Outlier detection</h4>
                </header>
                <form id="outlier-form" class="form-grid" novalidate aria-labelledby="outlier-section-title">
                  <div class="form-field">
                    <label class="form-field__label" for="outlier-columns">Columns</label>
                    <select id="outlier-columns" name="columns" multiple></select>
                    <p class="form-field__hint">Leave empty to inspect all numeric columns. Hold Ctrl or Cmd to select multiple entries.</p>
                  </div>
                  <div class="form-field">
                    <label class="form-field__label" for="outlier-threshold">Z-score threshold</label>
                    <input id="outlier-threshold" name="threshold" type="number" step="0.1" min="0.1" value="3.0">
                  </div>
                  <div class="form-actions">
                    <button class="btn" type="submit" id="detect-outliers">Detect outliers</button>
                    <button class="btn btn--ghost" type="button" id="remove-outliers">Remove outliers</button>
                  </div>
                  <p class="status-text" data-role="status" aria-live="polite"></p>
                </form>
                <div id="outlier-summary" class="tabular-outliers" hidden aria-live="polite"></div>
              </section>
              <section class="tabular-card">
                <header class="tabular-card__header">
                  <h4 class="form-section__title" id="filter-section-title">Filter rows</h4>
                </header>
                <form id="filter-form" class="form-grid" novalidate aria-labelledby="filter-section-title">
                  <div class="form-field">
                    <label class="form-field__label" for="filter-column">Column</label>
                    <select id="filter-column" name="column"></select>
                  </div>
                  <div class="form-field">
                    <label class="form-field__label" for="filter-operator">Operator</label>
                    <select id="filter-operator" name="operator">
                      <option value="eq">equals</option>
                      <option value="ne">does not equal</option>
                      <option value="gt">greater than</option>
                      <option value="gte">greater than or equal</option>
                      <option value="lt">less than</option>
                      <option value="lte">less than or equal</option>
                      <option value="contains">contains</option>
                      <option value="in">in list</option>
                    </select>
                  </div>
                  <div class="form-field">
                    <label class="form-field__label" for="filter-value">Value</label>
                    <input id="filter-value" name="value" placeholder="e.g. 42 or A, B">
                    <p class="form-field__hint">For "in list" separate entries with commas.</p>
                  </div>
                  <div class="form-actions">
                    <button class="btn" type="submit">Apply filter</button>
                    <button class="btn btn--ghost" type="reset" id="filter-reset">Reset</button>
                  </div>
                  <p class="status-text" data-role="status" aria-live="polite"></p>
                </form>
                <p id="filter-summary" class="form-field__hint" aria-live="polite"></p>
              </section>
            </div>
          </section>
        </section>
      </div>
    </div>
  </section>
  <div id="settings-dialog" class="tabular-settings" hidden>
    <div class="tabular-settings__backdrop" data-settings-close></div>
    <div class="tabular-settings__panel" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <header class="tabular-settings__header">
        <h2 id="settings-title" class="form-section__title">Settings</h2>
        <button type="button" class="settings-close" data-settings-close aria-label="Close settings">✕</button>
      </header>
      <div id="settings-content" class="tabular-settings__content"></div>
    </div>
  </div>
  <template id="scatter-settings-template">
    <form data-settings-form="scatter" class="form-grid">
      <div class="form-field">
        <label class="form-field__label" for="scatter-max-points">Maximum points</label>
        <input id="scatter-max-points" name="max_points" type="number" min="50" max="5000" step="50" value="400">
        <p class="form-field__hint">Large datasets are sampled for performance. Increase cautiously.</p>
      </div>
      <div class="form-field">
        <label class="form-field__label" for="scatter-point-size">Point size</label>
        <input id="scatter-point-size" name="point_size" type="range" min="2" max="10" step="1" value="4">
        <p class="form-field__hint">Adjust marker size for dense plots.</p>
      </div>
      <div class="form-actions">
        <button class="btn" type="submit">Apply settings</button>
      </div>
    </form>
  </template>
  <template id="histogram-settings-template">
    <form data-settings-form="histogram" class="form-grid">
      <div class="form-field">
        <label class="form-field__label" for="histogram-bins">Bins</label>
        <input id="histogram-bins" name="bins" type="number" min="5" max="120" value="30">
        <p class="form-field__hint">Number of bars in the histogram.</p>
      </div>
      <div class="form-field">
        <label class="form-field__label" for="histogram-density">Normalise counts</label>
        <select id="histogram-density" name="density">
          <option value="false" selected>Show counts</option>
          <option value="true">Show density</option>
        </select>
      </div>
      <div class="form-field">
        <label class="form-field__label" for="histogram-range-min">Custom range</label>
        <div class="settings-range">
          <input id="histogram-range-min" name="range_min" type="number" step="any" placeholder="Min">
          <input id="histogram-range-max" name="range_max" type="number" step="any" placeholder="Max">
        </div>
        <p class="form-field__hint">Leave blank to auto-detect bounds.</p>
      </div>
      <div class="form-actions">
        <button class="btn" type="submit">Apply settings</button>
      </div>
    </form>
  </template>
  <template id="training-settings-template">
    <form data-settings-form="training" class="form-grid">
      <p class="form-field__hint">Configure hyperparameters for the selected algorithm. Settings apply to upcoming training runs.</p>
      <div id="training-parameters" class="tabular-settings__parameters"></div>
      <div class="form-actions">
        <button class="btn" type="submit">Save hyperparameters</button>
        <button class="btn btn--ghost" type="button" data-settings-reset>Reset to defaults</button>
      </div>
    </form>
  </template>
{% endblock %}
{% block scripts %}
<script type="module" src="{{ url_for('tabular_ml.static', filename='js/index.js') }}"></script>
{% endblock %}
